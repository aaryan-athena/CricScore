{% extends "base.html" %}

{% block title %}Dashboard - CricScore+{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Welcome, Coach</h2>
            <p class="team-name">{{ team }}</p>
        </div>
        <nav class="sidebar-nav">
            <button class="nav-item active" data-page="players">
                <i class="fas fa-users"></i> Edit Player Details
            </button>
            <button class="nav-item" data-page="results">
                <i class="fas fa-trophy"></i> Team Results
            </button>
            <button class="nav-item" data-page="analytics">
                <i class="fas fa-chart-bar"></i> Player Analytics
            </button>
        </nav>
        <div class="sidebar-footer">
            <a href="/logout" class="btn btn-secondary">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Player Management Page -->
        <div id="players-page" class="page active">
            <h1>Manage Your Team</h1>
            
            <!-- Add Player Section -->
            <div class="card">
                <h3><i class="fas fa-user-plus"></i> Add / Register Player</h3>
                <form id="addPlayerForm" class="player-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="player-name">Player Name</label>
                            <input type="text" id="player-name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="player-role">Player Role</label>
                            <select id="player-role" name="role" required>
                                <option value="Batsman">Batsman</option>
                                <option value="Bowler">Bowler</option>
                                <option value="All-Rounder">All-Rounder</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Player
                    </button>
                </form>
            </div>

            <!-- Players List -->
            <div class="card">
                <h3><i class="fas fa-users"></i> Team Players</h3>
                <div id="players-list" class="players-grid"></div>
            </div>

            <!-- Edit Player Modal -->
            <div id="editPlayerModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Edit Player</h3>
                        <span class="close">&times;</span>
                    </div>
                    <form id="editPlayerForm">
                        <input type="hidden" id="edit-player-original" name="original_name">
                        <div class="form-group">
                            <label for="edit-player-name">Player Name</label>
                            <input type="text" id="edit-player-name" name="new_name" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-player-role">Player Role</label>
                            <select id="edit-player-role" name="new_role" required>
                                <option value="Batsman">Batsman</option>
                                <option value="Bowler">Bowler</option>
                                <option value="All-Rounder">All-Rounder</option>
                            </select>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Player</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Add Match Modal -->
            <div id="addMatchModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Add Match Record</h3>
                        <span class="close">&times;</span>
                    </div>
                    <form id="addMatchForm">
                        <input type="hidden" id="match-player-name" name="player_name">
                        
                        <!-- Basic Match Info -->
                        <div class="form-section">
                            <h4><i class="fas fa-info-circle"></i> Match Information</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="match-id">Match ID</label>
                                    <input type="text" id="match-id" name="match_id" required>
                                </div>
                            </div>
                        </div>

                        <!-- Batting Stats Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-baseball-ball"></i> Batting Stats</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="match-runs">Runs</label>
                                    <input type="number" id="match-runs" name="runs" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="match-balls-faced">Balls Faced</label>
                                    <input type="number" id="match-balls-faced" name="balls_faced" min="0" value="0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="match-fours">Fours</label>
                                    <input type="number" id="match-fours" name="fours" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="match-sixes">Sixes</label>
                                    <input type="number" id="match-sixes" name="sixes" min="0" value="0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="match-dot-balls">Dot Balls (Faced)</label>
                                    <input type="number" id="match-dot-balls" name="dot_balls" min="0" value="0">
                                </div>
                            </div>
                        </div>

                        <!-- Bowling Stats Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-bullseye"></i> Bowling Stats</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="match-wickets">Wickets</label>
                                    <input type="number" id="match-wickets" name="wickets" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="match-balls-bowled">Balls Bowled</label>
                                    <input type="number" id="match-balls-bowled" name="balls_bowled" min="0" value="0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="match-runs-conceded">Runs Conceded</label>
                                    <input type="number" id="match-runs-conceded" name="runs_conceded" min="0" value="0">
                                </div>
                            </div>
                        </div>

                        <!-- Fielding Stats Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-hand-paper"></i> Fielding Stats</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="match-catches">Catches</label>
                                    <input type="number" id="match-catches" name="catches" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="match-missed-catches">Missed Catches (Fielding Error)</label>
                                    <input type="number" id="match-missed-catches" name="missed_catches" min="0" value="0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="match-misfields">Misfields</label>
                                    <input type="number" id="match-misfields" name="misfields" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="match-missed-catches-batsman">Missed Catches (Batsman Benefited)</label>
                                    <input type="number" id="match-missed-catches-batsman" name="missed_catches_batsman" min="0" value="0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="match-missed-catches-bowler">Missed Catches (Bowler Affected)</label>
                                    <input type="number" id="match-missed-catches-bowler" name="missed_catches_bowler" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="match-overthrows">Overthrows (Extra Runs)</label>
                                    <input type="number" id="match-overthrows" name="overthrows" min="0" value="0">
                                </div>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Match</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Match Modal -->
            <div id="editMatchModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Edit Match Record</h3>
                        <span class="close">&times;</span>
                    </div>
                    <form id="editMatchForm">
                        <input type="hidden" id="edit-match-player-name" name="player_name">
                        <input type="hidden" id="edit-match-original-id" name="original_match_id">
                        
                        <!-- Match Selection -->
                        <div class="form-section">
                            <h4><i class="fas fa-search"></i> Select Match</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit-match-select">Select Match ID</label>
                                    <select id="edit-match-select" name="match_id" required>
                                        <option value="">Select a match...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Batting Stats Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-baseball-ball"></i> Batting Stats</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit-match-runs">Runs</label>
                                    <input type="number" id="edit-match-runs" name="runs" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="edit-match-balls-faced">Balls Faced</label>
                                    <input type="number" id="edit-match-balls-faced" name="balls_faced" min="0" value="0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit-match-fours">Fours</label>
                                    <input type="number" id="edit-match-fours" name="fours" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="edit-match-sixes">Sixes</label>
                                    <input type="number" id="edit-match-sixes" name="sixes" min="0" value="0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit-match-dot-balls">Dot Balls (Faced)</label>
                                    <input type="number" id="edit-match-dot-balls" name="dot_balls" min="0" value="0">
                                </div>
                            </div>
                        </div>

                        <!-- Bowling Stats Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-bullseye"></i> Bowling Stats</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit-match-wickets">Wickets</label>
                                    <input type="number" id="edit-match-wickets" name="wickets" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="edit-match-balls-bowled">Balls Bowled</label>
                                    <input type="number" id="edit-match-balls-bowled" name="balls_bowled" min="0" value="0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit-match-runs-conceded">Runs Conceded</label>
                                    <input type="number" id="edit-match-runs-conceded" name="runs_conceded" min="0" value="0">
                                </div>
                            </div>
                        </div>

                        <!-- Fielding Stats Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-hand-paper"></i> Fielding Stats</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit-match-catches">Catches</label>
                                    <input type="number" id="edit-match-catches" name="catches" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="edit-match-missed-catches">Missed Catches (Fielding Error)</label>
                                    <input type="number" id="edit-match-missed-catches" name="missed_catches" min="0" value="0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit-match-misfields">Misfields</label>
                                    <input type="number" id="edit-match-misfields" name="misfields" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="edit-match-missed-catches-batsman">Missed Catches (Batsman Benefited)</label>
                                    <input type="number" id="edit-match-missed-catches-batsman" name="missed_catches_batsman" min="0" value="0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit-match-missed-catches-bowler">Missed Catches (Bowler Affected)</label>
                                    <input type="number" id="edit-match-missed-catches-bowler" name="missed_catches_bowler" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="edit-match-overthrows">Overthrows (Extra Runs)</label>
                                    <input type="number" id="edit-match-overthrows" name="overthrows" min="0" value="0">
                                </div>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Match</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Team Results Page -->
        <div id="results-page" class="page">
            <h1>Team Results</h1>
            
            <div class="card">
                <div class="results-header">
                    <h3><i class="fas fa-trophy"></i> Top 11 Players by Efficiency</h3>
                    <div class="filter-controls">
                        <label for="role-filter">Filter by Role:</label>
                        <div class="custom-select-wrapper">
                            <select id="role-filter" class="custom-select">
                                <option value="All">All</option>
                                <option value="Batsman">Batsman</option>
                                <option value="Bowler">Bowler</option>
                                <option value="All-Rounder">All-Rounder</option>
                            </select>
                            <div class="select-arrow">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="results-table"></div>
                
                <div class="efficiency-formula">
                    <div class="formula-header" onclick="toggleFormulaDetails()">
                        <h4>Efficiency Formula Explained (by role) 
                            <span class="dropdown-arrow" id="formula-arrow">
                                <i class="fas fa-chevron-down"></i>
                            </span>
                        </h4>
                    </div>
                    
                    <div class="formula-content" id="formula-content" style="display: none;">
                        <!-- Quick Formula Summary -->
                        <div class="formula-summary">
                            <h5>Quick Formula Reference:</h5>
                            <ul>
                                <li><strong>Batsman:</strong> 2×Runs + 6×Fours + 8×Sixes + 1.5×Strike Rate + 8×Catches + 12×Wickets − 3×Dropped Catches − 2×Misfields − 1×Dot Balls − 2.5×Times Dropped − 0.5×Economy</li>
                                <li><strong>Bowler:</strong> 0.8×Runs + 2×Fours + 3×Sixes + 0.3×Strike Rate + 8×Catches + 30×Wickets + 6×Dropped Off Bowling − 5×Missed Catches − 3×Misfields + 0.5×Dot Balls − 4×Real Runs Given</li>
                                <li><strong>All-Rounder:</strong> 1.5×Runs + 5×Fours + 6×Sixes + 0.8×Strike Rate + 8×Catches + 22×Wickets + 4×Dropped Chances − 4×Missed Catches − 2.5×Misfields − 0.8×Dot Balls − 2.5×Times Dropped − 2.5×Real Runs Given</li>
                            </ul>
                            <p><strong>New Metric:</strong> Real Runs Given = Runs Conceded − Misfields Off Bowling − Overthrows Off Bowling</p>
                        </div>

                        <!-- Detailed Explanations -->
                        <div class="formula-explanations">
                            <h5>Detailed Formula Explanations:</h5>
                            
                            <div class="role-explanation">
                                <h6><i class="fas fa-baseball-ball"></i> Batsman Formula Explanation:</h6>
                                <p>This formula shows how impactful a batter was in a match. We reward the total runs scored (×2) and especially highlight boundaries [fours (×6) and sixes (×8)] since they change games quickly. A high strike rate (×1.5) shows how fast they scored.</p>
                                <p>If the batter also took catches or bowled and took wickets, we add those in (catches ×8, wickets ×12), since some batters contribute in the field too.</p>
                                <p>On the downside, they lose points for dot balls (×-1), being dropped (×-2.5) [which means they got lucky and survived a dismissal], misfields (×-2), and any catches they dropped (×-3). If they bowled and had a poor economy rate (×-0.5), that's also penalized.</p>
                            </div>

                            <div class="role-explanation">
                                <h6><i class="fas fa-bullseye"></i> Bowler Formula Explanation:</h6>
                                <p>This formula measures a bowler's overall match impact across bowling, fielding, and any batting they contribute. Wickets carry the highest weight (×30) since taking wickets is a bowler's core role. We also reward catches (×8) and chances that were dropped off their bowling (×6) because both reflect impact even when not directly recorded as wickets.</p>
                                <p>Batting stats like runs (×0.8), fours (×2), sixes (×3), and strike rate (×0.3) are included with smaller weight since they are secondary contributions for bowlers. Dot balls are rewarded (×0.5) because they build pressure and create opportunities.</p>
                                <p>We subtract points for missed catches (×-5) and misfields (×-3), which hurt team performance. The biggest penalty comes from real runs given (×-4), calculated by removing runs due to teammate errors like misfields and overthrows. This keeps the metric fair and focused on the bowler's actual responsibility.</p>
                            </div>

                            <div class="role-explanation">
                                <h6><i class="fas fa-user-friends"></i> All-Rounder Formula Explanation:</h6>
                                <p>All-rounders contribute in every part of the game, so this formula blends batting, bowling, and fielding impact. We reward runs (×1.5), fours (×5), and sixes (×6), and also consider strike rate (×0.8) to reflect batting quality.</p>
                                <p>On the bowling side, wickets (×22) carry big weight, and catches (×8) help reflect fielding contributions.</p>
                                <p>We take away points for misfields (×-2.5), dot balls (×-0.8), being dropped (×-2.5), and missed catches (×-4). Like for bowlers, we subtract real runs given (×-2.5) to ensure they aren't unfairly punished for fielding errors by others.</p>
                            </div>
                        </div>

                        <!-- Key Notes -->
                        <div class="formula-notes">
                            <h5>Important Notes:</h5>
                            <ul>
                                <li><strong>Strike Rate:</strong> (Runs/Balls Faced) × 100</li>
                                <li><strong>Economy Rate:</strong> Runs Conceded per Over (6 balls)</li>
                                <li><strong>Real Runs Given:</strong> Adjusted runs that exclude teammate fielding errors</li>
                                <li><strong>Dot Balls for Bowlers:</strong> Now rewarded (+0.5) as they build pressure and create opportunities</li>
                                <li><strong>Perspective-Based Scoring:</strong> Different weights for missed catches from batsman vs bowler perspective</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Player Analytics Page -->
        <div id="analytics-page" class="page">
            <h1>Player Analytics</h1>
            
            <div class="card">
                <div class="analytics-header">
                    <h3><i class="fas fa-chart-bar"></i> Select Player for Analysis</h3>
                    <div class="custom-select-wrapper">
                        <select id="analytics-player-select" class="custom-select">
                            <option value="">Select a player...</option>
                        </select>
                        <div class="select-arrow">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                </div>

                <!-- Analytics View Toggle -->
                <div id="view-toggle-section" class="view-toggle-section" style="display: none;">
                    <h4><i class="fas fa-eye"></i> View Type</h4>
                    <div class="view-toggle-buttons">
                        <button class="view-btn active" data-view="summary">Summary Stats</button>
                        <button class="view-btn" data-view="match">Per Match Analysis</button>
                        <button class="view-btn" data-view="trends">Performance Trends</button>
                    </div>
                </div>
                
                <!-- Player Summary Stats -->
                <div id="player-stats" class="player-stats-grid" style="display: none;"></div>
                
                <!-- Charts Section -->
                <div id="player-charts" class="charts-section" style="display: none;">
                    <div class="section-header">
                        <h4><i class="fas fa-chart-line"></i> Overall Performance Charts</h4>
                    </div>
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h4>Batting Performance</h4>
                            <canvas id="battingChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>Bowling Performance</h4>
                            <canvas id="bowlingChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>Efficiency Trend</h4>
                            <canvas id="efficiencyChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>Match-wise Performance</h4>
                            <canvas id="matchPerformanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Performance Trends Section -->
                <div id="performance-trends" class="trends-section" style="display: none;">
                    <div class="section-header">
                        <h4><i class="fas fa-analytics"></i> Detailed Performance Analysis by Category</h4>
                    </div>
                    <!-- Batting Trends -->
                    <div class="trend-category">
                        <h4><i class="fas fa-baseball-ball"></i> Batting Performance Trends</h4>
                        <div class="trends-grid">
                            <div class="chart-container">
                                <h5>Strike Rate Trend</h5>
                                <canvas id="strikeRateTrendChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h5>Runs per Match Trend</h5>
                                <canvas id="runsTrendChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h5>Boundaries Trend (Fours + Sixes)</h5>
                                <canvas id="boundariesTrendChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h5>Batting Efficiency Trend</h5>
                                <canvas id="battingEfficiencyTrendChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Bowling Trends -->
                    <div class="trend-category">
                        <h4><i class="fas fa-bullseye"></i> Bowling Performance Trends</h4>
                        <div class="trends-grid">
                            <div class="chart-container">
                                <h5>Economy Rate Trend</h5>
                                <canvas id="economyTrendChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h5>Wickets per Match Trend</h5>
                                <canvas id="wicketsTrendChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h5>Bowling Strike Rate Trend 
                                    <span class="chart-info-tooltip" data-tooltip="Pie chart showing: Wicket-taking (matches with ≥1 wicket), Economical (economy rate <6), Expensive (economy rate ≥6), Wicketless (0 wickets)">ℹ️</span>
                                </h5>
                                <canvas id="bowlingStrikeRateTrendChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h5>Bowling Efficiency Trend</h5>
                                <canvas id="bowlingEfficiencyTrendChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Fielding Trends -->
                    <div class="trend-category">
                        <h4><i class="fas fa-hand-paper"></i> Fielding Performance Trends</h4>
                        <div class="trends-grid">
                            <div class="chart-container">
                                <h5>Catches per Match Trend</h5>
                                <canvas id="catchesTrendChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h5>Fielding Accuracy Trend 
                                    <span class="chart-info-tooltip" data-tooltip="Doughnut chart showing: Catches Taken, Missed Catches, Misfields, Clean Fielding (matches with 0 missed catches AND 0 misfields)">ℹ️</span>
                                </h5>
                                <canvas id="fieldingAccuracyTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Per Match Details -->
                <div id="player-matches" class="matches-section" style="display: none;">
                    <h4><i class="fas fa-list"></i> Match-wise Performance</h4>
                    <div id="matches-table-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
